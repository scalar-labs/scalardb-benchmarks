# ScalarDB ベンチマークツール: システムパターン

## システムアーキテクチャ

ScalarDBベンチマークツールは、[Kelpie](https://github.com/scalar-labs/kelpie)というテストフレームワークを基盤として構築されています。全体的なアーキテクチャは以下の構成要素から成り立っています：

```
┌─────────────────────────────────────────────┐
│               ベンチマーク定義              │
│  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │
│  │ プリプロ │  │プロセッサ│  │ポストプロセッサ│  │
│  │ セッサ  │  │         │  │             │  │
│  └─────────┘  └─────────┘  └─────────────┘  │
└─────────────────────────────────────────────┘
          │            │            │
          ▼            ▼            ▼
┌─────────────────────────────────────────────┐
│             Kelpieフレームワーク            │
└─────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────┐
│                ScalarDB API                 │
└─────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────┐
│          データベース（バックエンド）         │
└─────────────────────────────────────────────┘
```

### コンポーネントの役割

1. **プリプロセッサ**: データロードや初期化処理を行う
   - TpccLoader: TPC-Cのテーブルにデータを投入
   - Loader: YCSBのデータを生成・投入
   - MultiStorageLoader: 複数ストレージ向けのデータを生成・投入
   - MultiUserLoader: マルチユーザーモード用のユーザー作成とデータロード

2. **プロセッサ**: 実際のベンチマーク処理を実行
   - TpccBench: TPC-Cワークロードの実行
   - WorkloadA/C/F: YCSBの各ワークロードの実行
   - MultiStorageWorkloadC/F: 複数ストレージのYCSBワークロード実行
   - MultiUserWorkloadC: 複数ユーザーによる並列読み取りワークロード

3. **ポストプロセッサ**: 結果集計とレポート生成
   - TpccReporter: TPC-Cの実行結果を集計・レポート
   - YcsbReporter: YCSBの実行結果を集計・レポート

## 主要な設計パターン

### 1. モジュール型設計

ベンチマークは異なるワークロードモジュールに分けられています：
- TPC-C関連クラス群
- YCSB関連クラス群
- マルチストレージYCSB関連クラス群
- マルチユーザーYCSB関連クラス群

各モジュールは独立して動作し、共通インターフェースや基底クラスを実装しています。

### 2. トランザクション設計パターン

特にTPC-Cの実装では、各トランザクションタイプがクラスとして表現されています：
- NewOrderTransaction
- PaymentTransaction
- OrderStatusTransaction
- DeliveryTransaction
- StockLevelTransaction

これらのトランザクションクラスは`TpccTransaction`インターフェースを実装し、一貫した操作方法を提供しています。

### 3. ファクトリーパターン

`TransactionFactory`クラスを使用してトランザクションマネージャのインスタンスを生成し、実装の詳細を隠蔽しています。

### 4. コンフィギュレーションパターン

TOMLファイルとJavaの設定クラスを使ってベンチマーク実行の設定を柔軟に行えるようになっています。

### 5. キー範囲分割パターン

マルチユーザーモードでは、各スレッドに固有のキー範囲を割り当てることで、アクセスの分散化を実現しています：
- 総レコード数をユーザー数で分割し、各ユーザーに均等な範囲を割り当て
- スレッドごとに割り当てられた範囲内からランダムにキーを選択
- ThreadLocalを使用して各スレッドの担当範囲を管理

### 6. ユーザー分離パターン

マルチユーザーモードでは、各スレッドがScalarDBの異なるユーザーとして動作します：
- 各ユーザーごとに個別のトランザクションマネージャーを作成
- 適切な権限を持つユーザーアカウントを自動的に作成
- スレッドID（ハッシュ値）に基づいてユーザーを割り当て

## コンポーネント間の関係

### データフロー

1. **設定読み込み**:
   - TOMLファイル → 各ベンチマークモジュール

2. **データ初期化**:
   - プリプロセッサ → ScalarDB API → データベース

3. **ベンチマーク実行**:
   - プロセッサ → ScalarDB API → データベース
   - プロセッサ → 測定結果 → ポストプロセッサ

4. **マルチユーザーモード特有のフロー**:
   - ユーザー作成 → 権限付与 → データロード → ユーザー別トランザクションマネージャー作成 → ワークロード実行

### 依存関係

- 各ベンチマークモジュールは`Common`クラスに依存
- トランザクション実装クラスはScalarDBのAPIに依存
- テーブル定義クラスはデータモデルを表現
- マルチユーザーモジュールは`DistributedTransactionAdmin`インターフェースに依存

## 重要な実装パス

### TPC-Cワークフロー

1. `TpccLoader`: スキーマに基づきデータ生成
2. `TpccBench`: 各トランザクションタイプの分布に従い実行
3. トランザクションクラス: ビジネスロジック実行
4. `TpccReporter`: 結果集計とレポート生成

### YCSBワークフロー

1. `Loader`: レコード生成と投入
2. `WorkloadX`: 特定のワークロードパターンに従い操作実行
3. `YcsbReporter`: 結果集計とレポート生成

### マルチユーザーYCSBワークフロー

1. `MultiUserLoader`: 
   - ScalarDBユーザーの作成と権限付与
   - 分散アクセス用のデータロード
2. `MultiUserWorkloadC`: 
   - 各スレッドに固有のユーザーと範囲を割り当て
   - キー範囲分割に基づく並列読み取り実行
3. `YcsbReporter`: 結果集計とレポート生成

## エラー処理戦略

1. **トランザクション競合**:
   - 競合検出時に自動リトライ
   - バックオフ戦略でリトライ間隔を調整（設定可能）

2. **例外ハンドリング**:
   - トランザクション内での例外発生時は適切にロールバック
   - Kelpieフレームワークへエラー情報を伝搬

3. **ユーザー作成エラー処理**:
   - 既存ユーザーの存在確認と削除
   - 権限付与失敗時の適切なエラーハンドリング
   - フォールバックメカニズム（ユーザー作成に失敗した場合は管理者権限で実行）

## スレッド管理

- 並行性（concurrency）パラメータで制御
- ワークロードごとに適切な並行実行数を設定可能
- 負荷テスト時にはこの値を調整して最大スループットを探索
- マルチユーザーモードではユーザー数（user_count）パラメータで制御

## パフォーマンス最適化

- トランザクション実装の効率化
- 適切なインデックス利用（オプションで制御可能）
- バッチ処理のサポート（特にロード時）
- リトライロジックの最適化
- キー範囲分割による並列アクセスの最適化
